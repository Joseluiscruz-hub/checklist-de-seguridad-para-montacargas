@if (view() === 'home') {
  <div class="bg-gray-50 dark:bg-gray-800 min-h-screen">
    <!-- Header -->
    <header class="bg-white dark:bg-dark-card shadow-sm sticky top-0 z-10">
      <div class="container mx-auto p-4 flex justify-between items-center max-w-2xl">
        <img [src]="logo" alt="Logo Coca-Cola FEMSA" class="h-10">
        <h1 class="text-xl font-bold text-gray-700 dark:text-gray-200 hidden sm:block">Checklist de Montacargas</h1>
        <div class="relative">
          <div (click)="isProfileMenuOpen.set(!isProfileMenuOpen())" class="w-10 h-10 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center cursor-pointer">
             <i class="fas fa-user text-xl text-gray-500 dark:text-gray-400"></i>
          </div>
          <!-- Profile Dropdown -->
          @if (isProfileMenuOpen()) {
            <!-- Backdrop to close on outside click -->
            <div (click)="isProfileMenuOpen.set(false)" class="fixed inset-0 z-10"></div>
            <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-dark-card rounded-md shadow-lg py-1 z-20 animate-fade-in-fast">
              <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-200">
                <p class="font-semibold">{{ userData.name }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">ID: {{ userData.id }}</p>
              </div>
              <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
              <a (click)="logout(); $event.preventDefault()" href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-accent w-full text-left">Cerrar Sesión</a>
            </div>
          }
        </div>
      </div>
    </header>

    <!-- Content -->
    <div class="p-4 max-w-2xl mx-auto">
      <!-- Greeting -->
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">¡Buenos días, {{ userData.name }}!</h2>
        <p class="text-gray-600 dark:text-gray-400">Montacargas Asignado: <strong>{{ userData.assignedForklift }}</strong></p>
        <p class="text-gray-600 dark:text-gray-400">Turno: <strong>{{ userData.shift }}</strong></p>
      </div>

      <!-- Main Action Card -->
      <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 mb-6">
        <h3 class="text-xl font-semibold mb-2 text-gray-800 dark:text-white">Inspección de Seguridad Diaria</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">Completa los puntos de revisión antes de iniciar tu operación para garantizar la seguridad.</p>
        <app-button (click)="goToSelectionView()">
          <i class="fas fa-play-circle"></i>
          <span>INICIAR NUEVO CHECKLIST</span>
        </app-button>
      </div>

      <!-- Quick Access -->
      <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">Accesos Rápidos</h3>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <app-button (click)="goToHistory()" variant="secondary">
          <i class="fas fa-history text-2xl"></i>
          <span class="text-sm">Historial de Inspecciones</span>
        </app-button>
        <app-button (click)="reportIncident()" variant="secondary">
          <i class="fas fa-exclamation-triangle text-2xl"></i>
          <span class="text-sm">Reportar Incidencia Grave</span>
        </app-button>
        <app-button (click)="consultManuals()" variant="secondary">
          <i class="fas fa-book text-2xl"></i>
          <span class="text-sm">Consultar Manuales</span>
        </app-button>
      </div>

      <!-- Sync Button -->
      <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 mb-6">
        <h3 class="text-xl font-semibold mb-2 text-gray-800 dark:text-white">Sincronización</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">Sincroniza tus datos con el servidor.</p>
        <app-button (click)="syncData()">
            <i class="fas fa-sync-alt"></i>
            <span>Sincronizar</span>
        </app-button>
      </div>
    </div>
    
    <!-- Footer -->
    <footer class="text-center p-4 mt-auto">
      <p class="text-xs text-gray-500 dark:text-gray-400">© {{ currentYear }} Coca-Cola FEMSA. Todos los derechos reservados.</p>
    </footer>
  </div>
} @else {
  <div class="container mx-auto p-4 max-w-2xl">
    <app-button (click)="goToHomeView()" variant="secondary">
      <i class="fas fa-arrow-left"></i>
      <span>Volver al Inicio</span>
    </app-button>
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Seleccionar Montacargas</h1>
      <p class="text-gray-600 dark:text-gray-400">Complete los checklists para la sesión actual.</p>
    </header>

    <!-- Session Details -->
    <div class="bg-white dark:bg-dark-card rounded-lg shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Detalles de la Sesión</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="inspector" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nombre del Inspector</label>
          <input type="text" id="inspector" [(ngModel)]="sessionInspector"
                class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 bg-gray-50 dark:bg-dark-accent dark:text-white">
        </div>
        <div>
          <label for="crew" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tripulación</label>
          <select id="crew" [(ngModel)]="sessionCrew"
                  [style.background-color]="sessionCrew() ? selectedCrewColor() : ''"
                  [class.text-black]="sessionCrew()"
                  [class.font-bold]="sessionCrew()"
                  class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 bg-gray-50 dark:bg-dark-accent dark:text-white transition-colors">
            <option value="" disabled>Seleccione tripulación</option>
            @for(crew of crews(); track crew.name) {
              <option [value]="crew.name" [style.background-color]="crew.color" class="text-black font-medium">{{ crew.name }}</option>
            }
          </select>
        </div>
        <div>
          <label for="shift" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Turno</label>
          <select id="shift" [(ngModel)]="sessionShift"
                  class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 bg-gray-50 dark:bg-dark-accent dark:text-white">
            <option value="1">Turno 1</option>
            <option value="2">Turno 2</option>
          </select>
        </div>
        <div>
          <label for="location" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Ubicación / Área</label>
          <select id="location" [(ngModel)]="sessionLocation"
                class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 bg-gray-50 dark:bg-dark-accent dark:text-white">
            <option value="" disabled>Seleccione un área</option>
            @for(area of areas(); track area) {
              <option [value]="area">{{ area }}</option>
            }
          </select>
        </div>
      </div>
    </div>

    <!-- Session Progress -->
    <div class="mb-4">
      <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-2">Progreso de la Sesión</h2>
      <app-progress-bar [value]="sessionSummary().completed" [max]="sessionSummary().total"></app-progress-bar>
    </div>

    <!-- Session Summary & Search -->
    <div class="mb-4">
        <div class="grid grid-cols-3 gap-2 text-center bg-white dark:bg-dark-card p-2 rounded-lg shadow mb-4">
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Completados</p>
                <p class="font-bold text-lg text-gray-800 dark:text-white">{{ sessionSummary().completed }} / {{ sessionSummary().total }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Con Incidencias</p>
                <p class="font-bold text-lg" [class.text-red-500]="sessionSummary().issues > 0" [class.text-gray-800]="sessionSummary().issues === 0" [class.dark:text-white]="sessionSummary().issues === 0">{{ sessionSummary().issues }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Pendientes</p>
                <p class="font-bold text-lg text-gray-800 dark:text-white">{{ sessionSummary().total - sessionSummary().completed }}</p>
            </div>
        </div>

        <div class="relative">
            <input type="text" [(ngModel)]="searchTerm" placeholder="Buscar por nombre, modelo o ID..."
                    class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-primary focus:border-primary bg-white dark:bg-dark-accent dark:text-white">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        </div>
    </div>

    <!-- Forklift List -->
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200">Montacargas</h2>
      <app-button (click)="openScanner()" variant="secondary">
        <i class="fas fa-qrcode"></i>
        <span>Escanear QR</span>
      </app-button>
    </div>
    <div class="space-y-3">
      @for (forklift of filteredForklifts(); track forklift.id) {
        <div class="bg-white dark:bg-dark-card rounded-lg shadow p-4 flex items-center justify-between">
          <div class="flex items-center gap-4">
            <span class="w-3 h-3 rounded-full"
                  [class.bg-gray-400]="getForkliftStatus(forklift.id) === 'pending'"
                  [class.bg-green-500]="getForkliftStatus(forklift.id) === 'ok'"
                  [class.bg-red-500]="getForkliftStatus(forklift.id) === 'issue'"></span>
            <div>
              <p class="font-semibold text-gray-800 dark:text-white">{{ forklift.name }}</p>
              <p class="text-sm text-gray-500 dark:text-gray-400">{{ forklift.model }} ({{ forklift.id }})</p>
            </div>
          </div>
          <app-button (click)="startChecklist(forklift)" variant="secondary">
            Verificar
          </app-button>
        </div>
      }
      @if (filteredForklifts().length === 0) {
        <div class="text-center py-6 bg-white dark:bg-dark-card rounded-lg shadow">
            <i class="fas fa-search text-3xl text-gray-400 mb-3"></i>
            <p class="text-gray-500 dark:text-gray-400">No se encontraron montacargas.</p>
        </div>
      }
    </div>

    <!-- Save Session -->
    @if (sessionHasChanges()) {
      <div class="mt-8">
        <app-button (click)="saveSession()" [disabled]="!isSessionInfoValid()">
          Guardar Sesión
        </app-button>
        @if (!isSessionInfoValid()) {
          <p class="text-center text-red-500 text-sm mt-2">Complete los detalles de la sesión para guardar.</p>
        }
      </div>
    }
  </div>
}


<!-- Checklist Modal -->
@if (isChecklistModalOpen() && selectedForklift()) {
  <app-checklist-modal [inspection]="selectedForklift()!" 
                       (save)="handleChecklistSave($event)" 
                       (close)="handleChecklistClose()" />
}

<!-- QR Scanner Modal -->
@if (isScannerOpen()) {
  <app-qr-scanner (scanSuccess)="handleScanSuccess($event)" 
                  (scanError)="handleScanError($event)"
                  (close)="isScannerOpen.set(false)" />
}

<!-- Incident Report Modal -->
@if (isIncidentModalOpen()) {
  <app-incident-report-modal 
    [forklifts]="forklifts()"
    (save)="handleSaveIncident($event)" 
    (close)="isIncidentModalOpen.set(false)" />
}

<!-- Manuals Modal -->
@if (isManualsModalOpen()) {
  <app-manuals-modal (close)="isManualsModalOpen.set(false)" />
}


<!-- Toast Notification -->
@if (toastMessage()) {
  <div class="fixed bottom-24 left-1/2 -translate-x-1/2 text-white py-2 px-6 rounded-full shadow-lg animate-fade-in-out"
       [class.bg-gray-800]="!toastIsError()"
       [class.bg-red-600]="toastIsError()">
    {{ toastMessage() }}
  </div>
}